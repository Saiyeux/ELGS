# 三路匹配系统使用说明

## 系统概述

`triple_matcher.py` 是ELGS项目的增强版本，实现了**三路特征匹配**系统：

1. **立体匹配**: 左右目相机间的空间对应关系
2. **左时序匹配**: 左目相机前后帧的运动跟踪
3. **右时序匹配**: 右目相机前后帧的运动跟踪

## 主要特性

### 核心功能
- ✅ 三种匹配模式：立体、左时序、右时序
- ✅ 智能匹配调度：全匹配、交替匹配、优先立体
- ✅ 时序轨迹叠加显示在相机画面上
- ✅ 独立的匹配可视化标签页
- ✅ GPU内存智能管理
- ✅ 实时三路匹配统计

### 界面特性
- 🎯 双目相机实时预览（带时序轨迹叠加）
- 📊 三路匹配统计面板（含GPU显存实时监控）
- 🗂️ 分标签页匹配可视化
- ⚙️ 完整的配置对话框
- 📝 实时状态日志
- 💾 GPU显存使用率实时显示和智能警告

## 启动方法

### 基本启动
```bash
python triple_matcher.py
```

### 高级参数启动
```bash
# 指定相机和匹配策略
python triple_matcher.py --cam0 0 --cam1 2 --strategy alternate

# 使用优化模型提升速度
python triple_matcher.py --model_type opt --precision fp16

# 完整参数示例
python triple_matcher.py \
    --cam0 0 --cam1 2 \
    --model_type full \
    --precision fp32 \
    --strategy alternate \
    --conf_thresh 0.2 \
    --resize_factor 0.8
```

## 参数说明

| 参数 | 默认值 | 说明 |
|------|--------|------|
| `--cam0` | 0 | 左目相机ID |
| `--cam1` | 2 | 右目相机ID |
| `--model_type` | full | 模型类型：`full`(高质量) 或 `opt`(高速度) |
| `--precision` | fp32 | 计算精度：`fp32`, `mp`, `fp16` |
| `--strategy` | alternate | 匹配策略：`all`, `alternate`, `priority` |
| `--conf_thresh` | 0.2 | 置信度阈值 |
| `--resize_factor` | 0.8 | 图像缩放因子 |

## 匹配策略详解

### 1. 全匹配 (all)
- **特点**: 每帧执行所有三种匹配
- **优势**: 最高质量，信息最完整
- **劣势**: GPU负载最高，可能影响实时性
- **适用**: GPU性能强劲，对质量要求极高

### 2. 交替匹配 (alternate) ⭐ 推荐
- **特点**: 轮流执行不同类型匹配
- **优势**: 平衡质量和性能，确保所有匹配都有更新
- **劣势**: 单一匹配类型更新频率降低
- **适用**: 大多数应用场景

### 3. 优先立体 (priority)  
- **特点**: 立体匹配优先，时序匹配次之
- **优势**: 保证核心立体匹配性能
- **劣势**: 时序匹配更新频率较低
- **适用**: 主要关注立体视觉，时序作为辅助

## 界面操作指南

### 主界面布局
```
┌─────────────────────────┬───────────────────┐
│                         │                   │
│   左目相机    右目相机   │    系统控制       │
│  (带时序轨迹) (带时序轨迹) │                   │
│                         │    显示选项       │
├─────────────────────────┤                   │
│ 立体:120 左时序:85 右时序:92 FPS:30 GPU:2GB/8GB(25%)
│                         │    系统信息       │
│      匹配可视化          │  (含详细显存信息)  │
│  ┌─立体┬─左时序┬─右时序┐ │                   │
│  │     │       │      │  │    状态日志       │
│  └─────┴───────┴──────┘ │                   │
└─────────────────────────┴───────────────────┘
```

### 操作步骤
1. **启动程序**: 运行脚本启动界面
2. **配置系统**: 点击"配置设置"调整相机和匹配参数
3. **开始匹配**: 点击"开始三路匹配"按钮
4. **观察结果**: 
   - 相机画面显示实时图像和时序轨迹
   - 统计面板显示三路匹配数量
   - 标签页显示详细匹配可视化
5. **调整显示**: 使用显示选项控制各类匹配的显示

### 可视化说明
- **绿色轨迹**: 左目时序匹配，显示在左相机画面
- **蓝色轨迹**: 右目时序匹配，显示在右相机画面  
- **连接线**: 立体匹配，在独立可视化区域显示
- **箭头**: 时序匹配方向，从历史帧指向当前帧

## GPU显存监控功能

### 实时显存监控
- **统计面板显示**: 实时显示GPU显存使用情况（已用/总计，使用率%）
- **详细信息面板**: 系统显存 vs PyTorch分配显存对比
- **智能警告**: 显存使用率超过80%时自动发出警告
- **定期报告**: 每200帧报告一次显存状态

### 显存使用说明
```
GPU显存: 2048/8192MB (25.0%)
├── 系统显存: 实际物理显存占用
├── PyTorch预留: PyTorch缓存的显存
└── PyTorch分配: 实际使用的显存
```

### 三路匹配对显存的影响
- **单一立体匹配**: ~500-800MB
- **三路全匹配**: ~1500-2400MB  
- **交替匹配**: ~800-1200MB
- **优先策略**: ~600-1000MB

## 性能优化建议

### GPU内存优化
- 使用`fp16`精度可节省40-50%显存但可能影响精度
- `alternate`策略相比`all`策略可减少50%GPU负载
- 设置合适的`resize_factor`平衡质量和性能
- 监控显存使用率，超过80%时考虑降低分辨率

### 实时性优化
- 降低`conf_thresh`可减少可视化计算
- 关闭不需要的显示选项
- 使用`opt`模型类型提升推理速度
- 观察GPU显存警告，及时调整参数

## 故障排除

### 常见问题
1. **"需要至少2个相机"**: 检查相机连接，调整相机ID
2. **"权重文件不存在"**: 确保EfficientLoFTR权重文件已下载
3. **GPU内存不足**: 降低图像分辨率或使用fp16精度
4. **匹配点过少**: 调整置信度阈值或改善光照条件

### 调试模式
```bash
# 启用详细日志输出
CUDA_LAUNCH_BLOCKING=1 python triple_matcher.py --strategy all
```

## 重要修复说明

### 坐标缩放修复
- **问题**: 原始版本时序匹配轨迹只显示在图像左上角小区域
- **原因**: 匹配坐标从预处理图像(缩放后)到原始图像的映射错误
- **修复**: 添加正确的坐标缩放计算 `scale_factor = 1.0 / resize_factor`
- **效果**: 时序轨迹现在正确覆盖整个图像范围

## 与原版对比

| 特性 | 原版matcher.py | 新版triple_matcher.py |
|------|---------------|----------------------|
| 匹配类型 | 仅立体匹配 | 立体+双目时序 |
| 显示方式 | 独立可视化 | 叠加+独立显示 |
| 调度策略 | 固定 | 三种可选策略 |
| 内存管理 | 基础 | 智能GPU内存管理 |
| 配置选项 | 有限 | 完整配置对话框 |
| 坐标映射 | N/A | 正确的缩放坐标映射 |

## 技术架构

```
相机输入 → 帧缓冲 → 匹配调度器 → EfficientLoFTR × 3 → 结果整合 → 界面显示
    ↓           ↓           ↓              ↓             ↓          ↓
  双目流    历史帧管理   智能任务分配    GPU内存优化   时序轨迹渲染  实时统计
```

这个三路匹配系统为ELGS项目提供了更强大的特征匹配能力，特别适合需要同时分析空间对应关系和时序运动的应用场景。
